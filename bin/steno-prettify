#!/usr/bin/env ruby

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile", __FILE__)

require "bundler"
Bundler.setup

require "optparse"
require "yajl"

require "steno/json_prettifier"

option_parser = OptionParser.new do |op|
  op.banner =<<EOT
Usage: steno-prettify [OPTS] [<log_filename>]

Parses json formatted log lines from log_filename (or stdin by default)
and displays a more human friendly version of each line to stdout.

Options:
EOT

  op.on("-h", "--help", "Display help") do
    puts op
    exit
  end
end

option_parser.parse!(ARGV)

input = STDIN
if ARGV.size > 0
  begin
    input = File.open(ARGV[0], "r")
  rescue => e
    puts "ERROR: Failed opening #{ARGV[0]}, #{e}"
    exit 1
  end
end

STDOUT.sync = true
prettifier = Steno::JsonPrettifier.new

lineno = 0
input.each_line do |line|
  begin
    print prettifier.prettify_line(line)
  rescue Yajl::ParseError => pe
    puts "ERROR: Malformed json at line #{lineno}, '#{line.strip}'"
  end

  lineno += 1
end
